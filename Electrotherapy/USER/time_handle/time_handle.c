#include "time_handle.h"
#include "main.h"
#include "tim.h"
#include <stdlib.h>
/*
*************************************
宏定义
*************************************
*/
/*
*************************************
宏定义
*************************************
*/
/*
*************************************
变量声明
*************************************
*/
int size=1000;
uint16_t sin_value[] = {500,503,506,509,512,515,518,521,525,528,531,534,537,540,543,547,
550,553,556,559,562,565,568,572,575,578,581,584,587,590,593,596,
599,602,606,609,612,615,618,621,624,627,630,633,636,639,642,645,
648,651,654,657,660,663,666,669,672,675,678,681,684,686,689,692,
695,698,701,704,707,710,712,715,718,721,724,726,729,732,735,738,
740,743,746,749,751,754,757,759,762,765,767,770,773,775,778,781,
783,786,788,791,793,796,798,801,803,806,808,811,813,816,818,821,
823,825,828,830,833,835,837,839,842,844,846,849,851,853,855,857,
860,862,864,866,868,870,872,875,877,879,881,883,885,887,889,891,
893,895,896,898,900,902,904,906,908,909,911,913,915,917,918,920,
922,923,925,927,928,930,931,933,935,936,938,939,941,942,944,945,
946,948,949,951,952,953,955,956,957,958,960,961,962,963,964,966,
967,968,969,970,971,972,973,974,975,976,977,978,979,980,981,981,
982,983,984,985,985,986,987,987,988,989,989,990,991,991,992,992,
993,993,994,994,995,995,996,996,996,997,997,997,998,998,998,998,
999,999,999,999,999,999,999,999,999,999,1000,999,999,999,999,999,
999,999,999,999,999,998,998,998,998,997,997,997,996,996,996,995,
995,994,994,993,993,992,992,991,991,990,989,989,988,987,987,986,
985,985,984,983,982,981,981,980,979,978,977,976,975,974,973,972,
971,970,969,968,967,966,964,963,962,961,960,958,957,956,955,953,
952,951,949,948,946,945,944,942,941,939,938,936,935,933,931,930,
928,927,925,923,922,920,918,917,915,913,911,909,908,906,904,902,
900,898,896,895,893,891,889,887,885,883,881,879,877,875,872,870,
868,866,864,862,860,857,855,853,851,849,846,844,842,839,837,835,
833,830,828,825,823,821,818,816,813,811,808,806,803,801,798,796,
793,791,788,786,783,781,778,775,773,770,767,765,762,759,757,754,
751,749,746,743,740,738,735,732,729,726,724,721,718,715,712,710,
707,704,701,698,695,692,689,686,684,681,678,675,672,669,666,663,
660,657,654,651,648,645,642,639,636,633,630,627,624,621,618,615,
612,609,606,602,599,596,593,590,587,584,581,578,575,572,568,565,
562,559,556,553,550,547,543,540,537,534,531,528,525,521,518,515,
512,509,506,503,500,496,493,490,487,484,481,478,474,471,468,465,
462,459,456,452,449,446,443,440,437,434,431,427,424,421,418,415,
412,409,406,403,400,397,393,390,387,384,381,378,375,372,369,366,
363,360,357,354,351,348,345,342,339,336,333,330,327,324,321,318,
315,313,310,307,304,301,298,295,292,289,287,284,281,278,275,273,
270,267,264,261,259,256,253,250,248,245,242,240,237,234,232,229,
226,224,221,218,216,213,211,208,206,203,201,198,196,193,191,188,
186,183,181,178,176,174,171,169,166,164,162,160,157,155,153,150,
148,146,144,142,139,137,135,133,131,129,127,124,122,120,118,116,
114,112,110,108,106,104,103,101,99,97,95,93,91,90,88,86,
84,82,81,79,77,76,74,72,71,69,68,66,64,63,61,60,
58,57,55,54,53,51,50,48,47,46,44,43,42,41,39,38,
37,36,35,33,32,31,30,29,28,27,26,25,24,23,22,21,
20,19,18,18,17,16,15,14,14,13,12,12,11,10,10,9,
8,8,7,7,6,6,5,5,4,4,3,3,3,2,2,2,
1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,
3,3,3,4,4,5,5,6,6,7,7,8,8,9,10,10,
11,12,12,13,14,14,15,16,17,18,18,19,20,21,22,23,
24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,41,
42,43,44,46,47,48,50,51,53,54,55,57,58,60,61,63,
64,66,68,69,71,72,74,76,77,79,81,82,84,86,88,90,
91,93,95,97,99,101,103,104,106,108,110,112,114,116,118,120,
122,124,127,129,131,133,135,137,139,142,144,146,148,150,153,155,
157,160,162,164,166,169,171,174,176,178,181,183,186,188,191,193,
196,198,201,203,206,208,211,213,216,218,221,224,226,229,232,234,
237,240,242,245,248,250,253,256,259,261,264,267,270,273,275,278,
281,284,287,289,292,295,298,301,304,307,310,313,315,318,321,324,
327,330,333,336,339,342,345,348,351,354,357,360,363,366,369,372,
375,378,381,384,387,390,393,397,400,403,406,409,412,415,418,421,
424,427,431,434,437,440,443,446,449,452,456,459,462,465,468,471,
474,478,481,484,487,490,493,496
};

uint16_t sine_wave[100] = {
    50,53,56,59,62,65,68,71,74,76,79,81,84,86,88,90,
92,93,95,96,97,98,99,99,99,100,99,99,99,98,97,96,
95,93,92,90,88,86,84,81,79,76,74,71,68,65,62,59,
56,53,50,46,43,40,37,34,31,28,25,23,20,18,15,13,
11,9,7,6,4,3,2,1,0,0,0,0,0,0,0,1,
2,3,4,6,7,9,11,13,15,18,20,23,25,28,31,34,
37,40,43,46
};

uint16_t sparse_wave[1000];
// = {
//    0x1000, 0x1100, 0x1200, 0x1300, 0x1400, 0x1500, 0x1600, 0x1700,
//    0x1800, 0x1900, 0x1A00, 0x1B00, 0x1C00, 0x1D00, 0x1E00, 0x1F00,
//    0x2000, 0x2100, 0x2200, 0x2300, 0x2400, 0x2500, 0x2600, 0x2700,
//    0x2800, 0x2900, 0x2A00, 0x2B00, 0x2C00, 0x2D00, 0x2E00, 0x2F00,
//    0x3000, 0x3100, 0x3200, 0x3300, 0x3400, 0x3500, 0x3600, 0x3700,
//    0x3800, 0x3900, 0x3A00, 0x3B00, 0x3C00, 0x3D00, 0x3E00, 0x3F00,
//    0x4000, 0x4100, 0x4200, 0x4300, 0x4400, 0x4500, 0x4600, 0x4700,
//    0x4800, 0x4900, 0x4A00, 0x4B00, 0x4C00, 0x4D00, 0x4E00, 0x4F00,
//    0x5000, 0x5100, 0x5200, 0x5300, 0x5400, 0x5500, 0x5600, 0x5700
//};
uint16_t intermittent_wave[1000];
//= {
//    0x1000, 0x0000, 0x2000, 0x0000, 0x3000, 0x0000, 0x4000, 0x0000,
//    0x5000, 0x0000, 0x6000, 0x0000, 0x7000, 0x0000, 0x8000, 0x0000,
//    0x9000, 0x0000, 0xA000, 0x0000, 0xB000, 0x0000, 0xC000, 0x0000,
//    0xD000, 0x0000, 0xE000, 0x0000, 0xF000, 0x0000, 0x0000, 0x1000,
//    0x0000, 0x2000, 0x0000, 0x3000, 0x0000, 0x4000, 0x0000, 0x5000,
//    0x0000, 0x6000, 0x0000, 0x7000, 0x0000, 0x8000, 0x0000, 0x9000,
//    0x0000, 0xA000, 0x0000, 0xB000, 0x0000, 0xC000, 0x0000, 0xD000,
//    0x0000, 0xE000, 0x0000, 0xF000, 0x1000, 0x0000, 0x2000, 0x0000,
//    0x3000, 0x0000, 0x4000, 0x0000, 0x5000, 0x0000, 0x6000, 0x0000
//};

/*
*************************************
变量定义
*************************************
*/
static uint16_t index_10ms = 0;  //用于记录10ms定时器的计数值
uint16_t index_led = 0;          //给Led的标志位

extern PWM_WAVE_MODE WAVE_channel;
/**
  * @brief          定时器2中断服务函数,10ms进一次中断
  * @param[in]      htim:定时器
  * @retval         none
  */
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)	
{
	if (htim->Instance == htim2.Instance)
	{
		index_10ms++;	 
		if(index_10ms%100==0)
		{
			index_led=1;
		}
		if(index_10ms>=200)
		{
			index_10ms = 0;
		}
	}
	static int i = 0;
	if(++i == size)i = 0;
	
	if (htim->Instance == htim3.Instance)
	{
		PWM_Mode1_SIN(&WAVE_channel);
//		__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_3, (float)100/100*(1000000/1000-1)*sin_value[i]/1000); //由向量表修改占空比 
	}
	
}

void generateSparseDenseArray(void) {
    srand(1234567890);
    
    // 生成 size 个疏密波样本
    for (int z = 0; z < size; z++) {
        int value = rand() % 1001;
        if (value < 300 || value > 700) {
            value = rand() % 701 + 150;
        }
        sparse_wave[z] = (unsigned short int)value;
    }     
}

/*
int numPulses: 表示要生成的脉冲(pulse)的数量。这个参数决定了最终数组中会包含多少个脉冲。
int pulseWidth: 表示每个脉冲的宽度,即脉冲持续的时间长度。
int pulseMin: 表示脉冲的最小幅值。
int pulseMax: 表示脉冲的最大幅值。
*/
void generateDiscreteWaveArray(int numPulses, int pulseWidth, int pulseMin, int pulseMax) {
    srand(1234567890);
	
    // 生成 numPulses 个脉冲
    for (int z = 0; z < numPulses; z++) {
        // 随机生成脉冲起始位置和幅值
        int start = rand() % (size - pulseWidth);
        int amplitude = rand() % (pulseMax - pulseMin + 1) + pulseMin;
        
        // 在数组中生成脉冲
        for (int j = start; j < start + pulseWidth; j++) {
            intermittent_wave[j] = (unsigned short int)amplitude;
        }
    } 
    // 将其他位置的值设置为 0
    for (int z = 0; z < size; z++) {
        if (intermittent_wave[z] == 0) {
            intermittent_wave[z] = 0;
        }
    }
	
}


/**
	* @brief  更新不同通道的波形
	* @param  None
	* @retval None
*/
uint16_t i = 0;
void update_pwm_waveform(const uint16_t* wave_array, float amplitude, uint16_t freq, uint8_t channel,uint16_t Array_Max_value) {
//    *index_ptr = (*index_ptr + freq) % 100;
	
	if(++i == 1000)i = 0;
    switch (channel) {
    case 0:
        __HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1,(float)amplitude*wave_array[i]/ Array_Max_value);  //wave_array[*index_ptr] / Array_Max_value 将数组的值映射到0-1
        break;
    case 1:
        __HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_2, (float)wave_array[i] * amplitude / Array_Max_value);
        break;
    case 2:
        __HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_3, (float)wave_array[i] * amplitude / Array_Max_value);
        break;
    default:
        return; 
    }
}

/**
    	* @brief  用于动态或静态选择波形、调节频率、幅值（频率统一可调，幅值分开可调）
    	* @param  WAVE  用于波形选择// 0: Sine, 1: Sparse, 2: Intermittent
		  @param  FREQ  统一频率可调  取值在0-100
		  @param  AMPL*  *可为1.2.3  用于调节不同通道幅值  取值范围为0-3.3V  通过(Freq*1000000-1)*(MODE->AMPL1)/3.3  映射到CCR
    	* @retval None
    */
void PWM_Mode1_SIN(PWM_WAVE_MODE* MODE) {
    const uint16_t* wave_array;
	uint16_t Array_Max_value;
    switch (MODE->WAVE) {
    case 0: // 正弦波
        wave_array = sin_value;
		Array_Max_value = 1000;
        break;
    case 1: // 疏密波
        wave_array = sparse_wave;
		Array_Max_value = 1000;
        break;
    case 2: // 断续波
        wave_array = intermittent_wave;
		Array_Max_value = 1000;
        break;
    default:
        return; // 如果波形类型不正确,则返回
    }

//	htim3.Init.Period = Freq*1000000-1;
	
	uint16_t freq = 300*MODE->FREQ;
	
	__HAL_TIM_SET_AUTORELOAD(&htim3, 1000000/freq-1);
	
 	float AMP1 = (1000000/freq-1)*(MODE->AMPL1)/100;
	float AMP2 = (1000000/freq-1)*(MODE->AMPL2)/100;
 	float AMP3 = (1000000/freq-1)*(MODE->AMPL3)/100; 

    // 更新三个通道的波形 
    update_pwm_waveform(wave_array, AMP1, freq, 0,Array_Max_value);
    update_pwm_waveform(wave_array, AMP2, freq, 1,Array_Max_value);
    update_pwm_waveform(wave_array, AMP3, freq, 2,Array_Max_value);
}

